name: Build Thermometer

on:
  workflow_dispatch: {}   # manual Run button
  push:
    paths:
      - "data/funds.json"
      - "scripts/render_thermometer.py"
      - "index.html"
      - "README.md"
      - ".github/workflows/**"
  pull_request:
    paths:
      - "data/funds.json"
      - "scripts/render_thermometer.py"
      - "index.html"
      - "README.md"
      - ".github/workflows/**"

permissions:
  contents: write

jobs:
  render:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Set up Python
        uses: actions/setup-python@v5
        with: { python-version: "3.x" }

      - name: Render SVG
        run: python scripts/render_thermometer.py

      - name: Bump cache-buster in README and index
        run: |
          set -e
          BUSTER="$(date -u +%Y%m%d%H%M%S)-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          # README.md
          sed -E -i "s|(\\./thermometer\\.svg)\\?v=[^\\)]+|\\1?v=${BUSTER}|g" README.md || true
          sed -E -i "s|\\]\\(\\./thermometer\\.svg\\)|](./thermometer.svg?v=${BUSTER})|g" README.md || true

          # index.html
          sed -E -i "s|(src=\"thermometer\\.svg)\\?v=[^\"]*|\\1?v=${BUSTER}|g" index.html || true
          sed -E -i "s|src=\"thermometer\\.svg\"|src=\"thermometer.svg?v=${BUSTER}\"|g" index.html || true

      - name: Commit updated files (SVG + cache-busted references)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update thermometer.svg and cache-bust references"
          file_pattern: "thermometer.svg README.md index.html"
